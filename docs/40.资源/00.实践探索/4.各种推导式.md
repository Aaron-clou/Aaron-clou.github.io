---
title: å„ç§æ¨å¯¼å¼
date: 2022-03-25 21:11:09
permalink: /pages/1d2420/
categories:
  - èµ„æº
  - Dafnyå®è·µæ¢ç´¢
tags:
  - 
---
# å„ç§æ¨å¯¼å¼

>*K. Rustan M. Leino Manuscript KRML 267, 27 May 2019*

**æ‘˜è¦** Dafnyæœ‰è®¸å¤šç±»ä¼¼æ¨å¯¼å¼çš„ç»“æ„ã€‚æœ¬æ–‡æè¿°å¹¶æ¯”è¾ƒäº†è¿™äº›ç»“æ„ï¼Œå±•ç¤ºäº†å®ƒä»¬åœ¨è¯­æ³•å’Œè¯­ä¹‰ä¸Šçš„æ¯”è¾ƒã€‚

Dafnyæ”¯æŒæ™®éé‡åŒ–å’Œå­˜åœ¨é‡åŒ–ï¼Œä»¥åŠç”¨äºâ€œè¯æ˜â€æ™®éé‡åŒ–è¡¨è¾¾å¼æˆ–â€œåˆ©ç”¨â€å­˜åœ¨é‡åŒ–è¡¨è¾¾å¼çš„ç»“æ„ã€‚[0]èŠ‚(http://leino.science/papers/krml267.html#sec-quantifiers)æè¿°äº†Dafnyä¸­çš„è¿™äº›é€»è¾‘é‡è¯ã€‚ç¬¬[1]èŠ‚(http://leino.science/papers/krml267.html#sec-proof-features)æ˜¾ç¤ºäº†åœ¨æ¨ç†é‡è¯æ—¶å¯ä»¥ä½¿ç”¨çš„ç¨‹åºè¯­å¥ï¼Œå¹¶æŒ‡å‡ºäº†å„ç§è¯­æ³•å½¢å¼çš„å·®å¼‚ã€‚

é›†åˆæ¨å¯¼å¼å’Œæ˜ å°„æ¨å¯¼å¼ç±»ä¼¼äºé‡è¯ï¼Œå› ä¸ºå®ƒä»¬å¼•å…¥äº†èŒƒå›´è¶…è¿‡ç‰¹å®šå€¼çš„ç»‘å®šå˜é‡ã€‚[2]èŠ‚(http://leino.science/papers/krml267.html#sec-sets-and-maps)å±•ç¤ºäº†è¿™äº›ç†è§£çš„ä¸€èˆ¬å’Œå¸¸è§å½¢å¼ã€‚

## é‡è¯

### åŸºæœ¬çš„é‡è¯çš„è¯­æ³•

åœ¨æ•°å­¦æ•™ç§‘ä¹¦å’Œè®ºæ–‡ä¸­ï¼Œæˆ‘ä»¬ç†Ÿæ‚‰çš„å…¨ç§°é‡è¯é‡‡ç”¨äº†ç±»ä¼¼çš„ç¬¦å·ã€‚å®ƒè¯´è°“è¯å¯¹æ‰€æœ‰çš„å€¼éƒ½æˆç«‹ã€‚åœ¨ç¼–ç¨‹è¯­è¨€è¡Œè¯ä¸­ï¼Œæˆ‘ä»¬è¯´å®ƒæ˜¯ä¸€ä¸ª*ç»‘å®šå˜é‡*ï¼Œå…¶ä½œç”¨åŸŸæ˜¯é‡è¯çš„*ä¸»ä½“*ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»ä½•è‡ªç”±å‡ºç°çš„inéƒ½è¢«ç»‘å®šåˆ°é‡è¯æ‰€å¼•å…¥çš„ã€‚

åœ¨Dafnyä¸­ï¼ŒåŒä¸€ä¸ªå…¨ç§°é‡è¯è¢«å†™æˆ`forall x:: P`ã€‚ä»è§£æçš„è§’åº¦æ¥çœ‹ï¼Œé‡è¯çš„ä¸»ä½“â€œå°½å¯èƒ½åœ°â€æ‰©å±•ã€‚å› æ­¤ï¼Œç¨‹åºç‰‡æ®µ

```dafny
forall x :: R ==> Q
```

è§£æä¸º

```dafny
(forall x :: (R ==> Q))
```

è€Œä¸æ˜¯

```dafny
(forall x :: R) ==> Q
```

è¯·æ³¨æ„ï¼Œâ€œå°½å¯èƒ½â€ä¸é™äºè¡Œå°¾ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¸¸è§çš„é™·é˜±æ˜¯ç¼–å†™(è¿™é‡Œæ˜¾ç¤ºçš„æ˜¯ä¸€ä¸ªå‰ç½®æ¡ä»¶)

```dafny
requires
  forall x :: R ==> Q &&
  S
```

æ„å›¾æ˜¯` forall x:: R ==> Q `å’Œ` S `æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å‰ææ¡ä»¶ã€‚ä¸æ­¤ç›¸åçš„æ˜¯ï¼Œè¿™é‡Œæ‰€å†™çš„å£°æ˜çš„æ„ä¹‰æ˜¯

```dafny
requires (forall x :: (R ==> (Q && S)))
```

å¦‚æœä½ æ‰“ç®—å†™é‡è¯å’ŒSçš„è¿è¯ï¼Œé‚£ä¹ˆæ­£ç¡®çš„è¯­æ³•æ˜¯

```dafny
requires
  (forall x :: R ==> Q) &&
  S
```

å­˜åœ¨é‡è¯çš„ä¸€ä¸ªç†Ÿæ‚‰çš„æ•°å­¦ç¬¦å·æ˜¯ã€‚å®ƒè¯´è°“è¯å¯¹äºæŸä¸ªå€¼æˆç«‹ã€‚åœ¨Dafnyä¸­ï¼Œè¯­æ³•æ˜¯` exists x:: P ` .[0](http://leino.science/papers/krml267.html#fn-fn-emacs)

### ç»‘å®šå˜é‡çš„ç±»å‹

Dafnyä¸­çš„æ¯ä¸ªå˜é‡éƒ½æœ‰ä¸€ä¸ªç±»å‹ã€‚é€šå¸¸ï¼Œç»‘å®šå˜é‡çš„ç±»å‹æ˜¯æ¨æ–­çš„ï¼Œä½†Dafnyä¹Ÿå…è®¸æ˜¾å¼å£°æ˜è¯¥ç±»å‹ã€‚ä¾‹å¦‚,

```dafny
forall x: X :: P
```

å£°æ˜` x `çš„ç±»å‹ä¸º` x `ã€‚ä¸ºäº†ç®€æ´ï¼Œå¹¶å±•ç¤ºç¼–å†™é‡è¯å’Œæ¨æ–­çš„å…¸å‹æ–¹æ³•ï¼Œæˆ‘å°†åœ¨æœ¬æ–‡ä¸­çœç•¥ç±»å‹ï¼Œä½†è¯·è®°ä½ï¼Œå¦‚æœæ„¿æ„ï¼Œæ‚¨å¯ä»¥éšæ—¶åŒ…å«å®ƒä»¬ã€‚

å½“çº¦æŸå˜é‡ä»æŸä¸ªé›†åˆä¸­æå–æ—¶ï¼Œé‡è¯çš„å¸¸ç”¨æ•°å­¦ç¬¦å·æ˜¯ã€‚è¿™ä¸ªè¡¨è¾¾å¼çš„dafnyå¼è¡¨ç¤ºä¸º

```dafny
forall x in S :: P  // error: syntax error
```

ç„¶è€Œï¼Œè¿™æ˜¯ä¸æ­£ç¡®çš„Dafnyè¯­æ³•ï¼Œå› ä¸ºå®ƒä½¿ç”¨äº†ä¸€ä¸ªé›†åˆæˆå‘˜è°“è¯ï¼Œå…¶ä¸­åªæœŸæœ›ç»‘å®šå˜é‡(å¯é€‰çš„ï¼Œå¸¦æœ‰ç±»å‹)ã€‚åœ¨Dafnyä¸­è¿™æ ·ä¸€ä¸ªé‡è¯çš„æ­£ç¡®å†™æ³•æ˜¯

```dafny
forall x :: x in S ==> P
```

### å¤šä¸ªç»‘å®šå˜é‡

ä¸€ä¸ªé™å®šç¬¦å¯ä»¥æœ‰ä¸€ä¸ªä»¥ä¸Šçš„ç»‘å®šå˜é‡ã€‚ä¾‹å¦‚,

```dafny
forall x, y :: P
```

På¯¹äºæ‰€æœ‰çš„xå’Œyéƒ½æˆç«‹ã€‚å®ƒåœ¨é€»è¾‘ä¸Šç­‰åŒäºåµŒå¥—çš„é‡è¯

```dafny
forall x :: forall y :: P
```

å°±æ­¤è€Œè¨€ï¼Œå®ƒåœ¨é€»è¾‘ä¸Šä¹Ÿç­‰ä»·äº

```dafny
forall y :: forall x :: P
```

Dafnyçš„å¸¸è§åšæ³•æ˜¯ä½¿ç”¨å¤šä¸ªå˜é‡çš„é‡è¯ï¼Œè€Œä¸æ˜¯åµŒå¥—çš„å½¢å¼ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–åŸå› ï¼Œåªæ˜¯ä¸ºäº†æ›´ç®€æ´ã€‚[1](http://leino.science/papers/krml267.html#fn-fn-nested)

å¦‚æœæ‚¨ç¼–å†™äº†ä¸€ä¸ªç»‘å®šå˜é‡åˆ—è¡¨å¹¶æ˜¾å¼åœ°ç»™å‡ºäº†ç±»å‹ï¼Œè¯·æ³¨æ„ï¼Œæ¯ä¸ªç»™å®šçš„ç±»å‹åªé€‚ç”¨äºå®ƒä¹‹å‰çš„å˜é‡ã€‚ä¾‹å¦‚,

```dafny
forall x: X, y: Y :: P
```

xçš„ç±»å‹æ˜¯x, yçš„ç±»å‹æ˜¯yã€‚å¦‚æœåªåŒ…å«yç±»å‹ï¼Œå¦‚

```dafny
forall x, y: Y :: P
```

é‚£ä¹ˆä½ è¯´` y `çš„ç±»å‹æ˜¯` y `è€Œ` x `çš„ç±»å‹æ˜¯å¯ä»¥æ¨æ–­çš„ã€‚æ¢å¥è¯è¯´ï¼Œä½ å¯ä»¥è®¤ä¸ºè¿™ä¸ªâ€œ`:`â€æ¯”â€œ`ï¼Œ`â€å…·æœ‰æ›´å¼ºçš„çº¦æŸåŠ›ã€‚

### é‡è¯ä¸»ä½“çš„å…¸å‹å½¢å¼

å…¨ç§°é‡è¯çš„ä¸»ä½“é€šå¸¸æ˜¯ä¸€ç§å«ä¹‰ï¼Œå¦‚in

```dafny
forall x :: R ==> P
```

ä½ å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥è§£è¯»:

> "å¯¹äºæ‰€æœ‰çš„` x `ï¼Œæ„å‘³ç€` R ==> P `æˆç«‹"
>
> "å¯¹äºæ‰€æœ‰çš„` x `ï¼Œ ` R `æ„å‘³ç€` P ` "
>
> "å¯¹äºæ‰€æœ‰çš„` x `ï¼Œå¦‚æœ` R `æˆç«‹ï¼Œé‚£ä¹ˆ` P `ä¹Ÿæˆç«‹"

ç„¶è€Œï¼Œè¿™ä¸ªå«ä¹‰çš„å…ˆè¡Œè¯(` R `)é€šå¸¸èµ·åˆ°é™åˆ¶(ä¸ä»…ä»…æ˜¯` x `çš„ç±»å‹)æ‰€è€ƒè™‘çš„` x `çš„å€¼çš„ä½œç”¨ã€‚æ¢å¥è¯è¯´ï¼Œâ€œRâ€å‘Šè¯‰ä½ â€œxâ€çš„èŒƒå›´ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä»ä¸‹é¢çš„ä¸€ç§æ–¹å¼æ¥è§£è¯»ä¸Šé¢çš„é‡è¯:

> "å¯¹äºæ‰€æœ‰æ»¡è¶³Rçš„` x `ï¼Œ ` P `æˆç«‹
>
> "å¯¹äºæ‰€æœ‰çš„` x `ï¼Œä½¿` R `æˆç«‹ï¼Œ` P ` "
>
> "å¯¹äºæ‰€æœ‰çš„` x `(å…¶ä¸­` x `æ»¡è¶³` R `)ï¼Œ ` P `ä¿æŒ"
>
>â€œå¯¹äºæ‰€æœ‰çš„`x`[ä¸º`R`æ’å…¥ä½ è‡ªå·±çš„æè¿°æ€§é˜¶æ®µ]ï¼Œ`P`â€

ä½œä¸ºæœ€åä¸€ä¸ªçŸ­è¯­çš„å…·ä½“å®ä¾‹ï¼Œä½ å¯ä»¥è¯»åˆ°` forall x:: x in S ==> x % 2 == 0 ` As

> "å¯¹äº` S `ä¸­çš„æ‰€æœ‰` x `ï¼Œ ` x `æ˜¯å¶æ•°"

ä½ å¯ä»¥è¯»åˆ°` forall i:: 0 <= i < a. length ==> a[i] == 5 ` as

> "å¯¹äºæ•°ç»„` a `çš„æ¯ä¸ªä¸‹æ ‡` i `ï¼Œ ` a ` -sub- ` i `æ˜¯` 5 ` "

å’Œæˆ‘åˆšæ‰è¯´çš„å…¨ç§°é‡è¯ç±»ä¼¼ï¼Œå­˜åœ¨é‡è¯çš„å…¸å‹å½¢å¼æ˜¯è¿è¯ï¼Œæ¯”å¦‚

```dafny
exists x :: R && P
```

ä¾‹å¦‚ï¼š

```dafny
exists x :: x in S && x % 2 == 0

exists i :: 0 <= i < a.Length && a[i] == 5
```

å†æŠŠRçœ‹æˆæ˜¯å‘Šè¯‰ä½ xçš„èŒƒå›´ï¼Œä½ å¯ä»¥æŠŠè¿™äº›å­˜åœ¨é‡è¯çœ‹æˆ

> "åœ¨` S `ä¸­æœ‰ä¸€ä¸ª` x `ï¼Œå…¶ä¸­` x % 2 == 0 `é€‚ç”¨"
>
> "åœ¨aä¸­æœ‰ä¸€ä¸ªç´¢å¼•iï¼Œä½¿a -sub- iç­‰äº5 "

åœ¨Why3 [[1](http://leino.science/papers/krml267.html#boogie2011:why3)]ä¹‹åï¼Œå¦‚æœä½ å°†` R ==> P `ä½œä¸ºå­˜åœ¨é‡è¯çš„ä¸»ä½“ï¼ŒDafnyä¼šå‘å‡ºè­¦å‘Šï¼Œå› ä¸ºè¿™å‡ ä¹æ€»æ˜¯ä¸€ä¸ªç”¨æˆ·é”™è¯¯(ä¸€ä¸ªæ‰“å­—é”™è¯¯æˆ–ä¸€ä¸ªæ€è€ƒ-o)ã€‚å¦‚æœè¿™çœŸçš„æ˜¯ä½ æƒ³è¦å†™çš„ï¼Œä½ å¯ä»¥é€šè¿‡ç¼–å†™ä»¥ä¸‹ä»»ä½•è¡¨è¾¾å¼æ¥æŠ‘åˆ¶è­¦å‘Š:

```dafny
exists x :: (R ==> P)
exists x :: !R || P
exists x :: P <== R
```

### èŒƒå›´è°“è¯

ä¸ºä»€ä¹ˆæˆ‘è¦èŠ±ä¸€é¡µæ¥å‘Šè¯‰ä½ é‡è¯çš„å‘éŸ³?å› ä¸ºè¿™ä¸ªè®¨è®ºå¼ºè°ƒäº†ä¸€ä¸ªäº‹å®ï¼Œæ¡ä»¶Rï¼Œåœ¨ä»»ä½•ä¸€ä¸ª

```dafny
forall x :: R ==> P
exists x :: R && P
```

æ‰®æ¼”ç€ç‰¹æ®Šçš„è§’è‰²ï¼Œå°½ç®¡â€œRâ€å®é™…ä¸Šåªæ˜¯è¿™äº›é‡è¯ä¸»ä½“çš„ä¸€éƒ¨åˆ†ã€‚äº‹å®ä¸Šï¼Œå…¶ä»–äººå·²ç»ä¸ºé‡è¯é‡‡ç”¨äº†ä¸€ç§è¡¨ç¤ºæ³•ï¼Œè¯¥è¡¨ç¤ºæ³•ä¸ºè¿™ä¸ª*èŒƒå›´è°“è¯* ` R `è®¾ç½®äº†ä¸€ä¸ªç‰¹æ®Šçš„ä½ç½®ã€‚ä¸‹é¢æ˜¯ä¸€äº›ä¾‹å­:

|                      |                        |                                                              |
| -------------------- | ---------------------- | ------------------------------------------------------------ |
| Universal quantifier | Existential quantifier | Source                                                       |
|                      |                        |                                                              |
|                      |                        | Dijkstra [[3](http://leino.science/papers/krml267.html#dijkstra:discipline)] |
|                      |                        | Chandy and Misra [[2](http://leino.science/papers/krml267.html#chandymisra:book)] |
|                      |                        | Gries and Schneider [[4](http://leino.science/papers/krml267.html#griesschneider:proofs)] |
| `\forall X x; R; P`  | `\exists X x; R; P`    | JML [[5](http://leino.science/papers/krml267.html#leavensbakerruby99a)] |
|                      |                        |                                                              |

(åœ¨ä¸Šé¢çš„JMLä¸­ï¼Œ` X `è¡¨ç¤º` X `çš„ç±»å‹ã€‚)åœ¨ä½¿ç”¨è¿™äº›ç¬¦å·çš„æ•™ç§‘ä¹¦ä¸­ï¼Œç»å¸¸æœ‰äººè¯´:â€œä¸ºäº†ç®€æ´ï¼Œå¦‚æœâ€˜Râ€™æ˜¯â€˜æ­£ç¡®â€™çš„ï¼Œæˆ–è€…æ˜¯æ ¹æ®ä¸Šä¸‹æ–‡ç†è§£çš„ï¼Œé‚£ä¹ˆå®ƒ(å¯¹äºä¸Šé¢çš„ä¸€äº›ä½œè€…æ¥è¯´ï¼Œä¸€äº›ç›¸é‚»çš„æ ‡ç‚¹ç¬¦å·)å°±è¢«çœç•¥äº†ã€‚â€è¿™äº›ç¼©å†™å½¢å¼æ˜¯:

|                         |                         |                                                              |
| ----------------------- | ----------------------- | ------------------------------------------------------------ |
| Range listed separately | Range `true` or omitted | Source                                                       |
|                         |                         |                                                              |
|                         |                         | Dijkstra [[3](http://leino.science/papers/krml267.html#dijkstra:discipline)] |
|                         |                         | Chandy and Misra [[2](http://leino.science/papers/krml267.html#chandymisra:book)] |
|                         |                         | Gries and Schneider [[4](http://leino.science/papers/krml267.html#griesschneider:proofs)] |
| `\forall X x; R; P`     | `\forall X x;; P`       | JML [[5](http://leino.science/papers/krml267.html#leavensbakerruby99a)] |
|                         |                         |                                                              |

è¿˜æœ‰æ›´å¤šçš„ã€‚é€šè¿‡ä½¿ç”¨ä¸€äº›åŒºåˆ†â€œRâ€å’Œâ€œPâ€çš„ç¬¦å·ï¼Œé‡è¯çš„å¾·æ‘©æ ¹å®šå¾‹çœ‹èµ·æ¥ç‰¹åˆ«å¥½:



å›åˆ°Dafnyã€‚å¦‚æœæ‚¨å–œæ¬¢å°†ç»‘å®šå˜é‡çš„èŒƒå›´ä»é‡è¯ä¸»ä½“çš„å…¶ä½™éƒ¨åˆ†åˆ†éš”å¼€çš„ç¬¦å·ï¼Œé‚£ä¹ˆæ‚¨å°†å¾ˆé«˜å…´åœ°äº†è§£åˆ°ï¼Œæ‚¨ä¹Ÿå¯ä»¥åœ¨Dafnyä¸­è¿™æ ·åšã€‚è¯­æ³•æ˜¯:

```dafny
forall x | R :: P
exists x | R :: P
```

## ç”¨äºé‡è¯æ¨ç†çš„ç¨‹åºè¯­å¥

DafnyåŒ…å«äº†ä¸€äº›åœ¨æ¨ç†æ¶‰åŠé‡è¯çš„ç¨‹åºæˆ–å®šç†æ—¶éå¸¸æœ‰ç”¨çš„è¯æ˜ç‰¹æ€§ã€‚å®ƒä»¬çš„è¯­æ³•ä¸é‡è¯ç›¸ä¼¼ï¼Œä½†ä¹Ÿæœ‰åŒºåˆ«ã€‚

### èšåˆè¯­å¥

Dafnyä¸­çš„` forall `è¯­å¥æ˜¯ä¸€ä¸ª*èšåˆè¯­å¥*:å®ƒå…·æœ‰æ‰§è¡Œå¤šä¸ªåŒæ—¶æ“ä½œçš„æ•ˆæœã€‚å½“è¿™å¥è¯ç”¨äºè¯æ˜æ—¶ï¼Œå…¶å½¢å¼å¦‚ä¸‹:

```dafny
forall x | R
  ensures P
{
  S;
}
```

å®ƒç”¨äºå»ºç«‹å±æ€§` forall x | R:: P `ï¼Œå³` forall x:: R == >p `ã€‚å®ƒæ˜¯é€šè¿‡æ£€éªŒå‘½é¢˜` S `ä¸ºä»»ä½•æ»¡è¶³` R `çš„` x `å»ºç«‹` P `æ¥å®ç°çš„ã€‚åœ¨é€»è¾‘ä¸­ï¼Œè¿™ä¸ªå‘½é¢˜çš„ç»“æœè¢«ç§°ä¸ºâ€œæ™®éå¼•å…¥â€ã€‚

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾ä½ æœ‰ä¸€ä¸ªå¼•ç†å¯ä»¥è¯æ˜` n <= Fib(n) `å¯¹äºä»»ä½•` n `è‡³å°‘æ˜¯` 5 `ï¼Œå…¶ä¸­` Fib `æ˜¯é€šå¸¸çš„Fibonacciå‡½æ•°:

```dafny
function Fib(n: nat): nat {
  if n < 2 then n else Fib(n-2) + Fib(n-1)
}

lemma FibProperty(n: nat)
  requires 5 <= n
  ensures n <= Fib(n)
{
  // some proof goes here
}
```

è¿™ä¸ªå¼•ç†ç»™å‡ºäº†ä¸€ä¸ªç»™å®š` n `çš„å±æ€§` n <= Fib(n) `ã€‚ä½†å‡è®¾ä½ æƒ³è®©è¿™ä¸ªæ€§è´¨ä»¥æ™®éé‡å­åŒ–çš„å½¢å¼å­˜åœ¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ è¦è¯æ˜ä¸‹é¢çš„å¼•ç†:

```dafny
lemma FibPropertyAll()
  ensures forall n :: 5 <= n ==> n <= Fib(n)
{
  // some proof to go here
}
```

æˆ‘ä»¬æ€ä¹ˆå†™è¿™ä¸ªè¯æ˜å‘¢?[2](http://leino.science/papers/krml267.html#fn-fn-fibpropertyall)

ç­”æ¡ˆæ˜¯å¯¹æ¯ä¸ª` n `è°ƒç”¨` FibProperty `ä¸€æ¬¡ã€‚ä¸€æ¬¡ã€‚å¯¹äºâ€œnâ€æœ‰æ— æ•°ä¸ªä¸åŒçš„å€¼ã€‚è¿™å°±æ˜¯ä½ å¯¹èšåˆè¯­å¥` forall `æ‰€åšçš„:

```dafny
forall n | 5 <= n
  ensures n <= Fib(n)
{
  FibProperty(n);
}
```

ä¸€èˆ¬æ¥è¯´ï¼Œforallè¯­å¥çš„ä¸»ä½“è¦æ¯”å•ä¸ªå¼•ç†è°ƒç”¨å¤æ‚å¾—å¤šã€‚ä½†æ˜¯å½“ä¸»ä½“*æ˜¯*åªæ˜¯ä¸€ä¸ªå¼•ç†è°ƒç”¨æˆ–åªæ˜¯ä¸€ä¸ª` calc `è¯­å¥æ—¶ï¼ŒDafnyä¼šè‡ªåŠ¨æ¨æ–­` ensure `å­å¥ï¼Œæ‰€ä»¥ä½ å¯ä»¥çœç•¥å®ƒ:

```dafny
forall n | 5 <= n {
  FibProperty(n);
}
```

### å­˜åœ¨å¼•å…¥ä¸æ’é™¤

ä½¿ç”¨å­˜åœ¨é‡åŒ–è¿˜ä½¿ç”¨äº†ä¸€ç³»åˆ—çš„è¯æ˜ç‰¹å¾ã€‚æˆ‘å°†é€šè¿‡å†™ä¸€ä¸ªè¯æ˜æ¥è¯æ˜æ–æ³¢é‚£å¥‘æ•°å¯ä»¥æ˜¯ä»»æ„å¤§çš„:

```dafny
lemma EverBigger(k: nat)
  ensures exists n :: k <= Fib(n)
{
  // proof to go here
}
```

è®©æˆ‘ä»¬ä»ä¸€äº›ç®€å•çš„ä¾‹å­å¼€å§‹è¯æ˜ï¼Œæ¯”å¦‚å½“kå¾ˆå°çš„æ—¶å€™ï¼Œæ¯”å¦‚0æˆ–1:

```dafny
if k < 2 {
  // simple case: proof for k being 0 or 1 goes here
} else {
  // difficult case: proof for larger k goes here
}
```

Dafnyä¸èƒ½è‡ªåŠ¨è¯æ˜è¿™ä¸¤ç§æƒ…å†µï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªå·±ç»™å‡ºæ›´å¤šçš„è¯æ˜ã€‚

ä¸ºäº†è¯æ˜è¿™ä¸ªå¼•ç†åœ¨ç®€å•çš„æƒ…å†µä¸‹ï¼Œå®ƒè¶³ä»¥å‘éªŒè¯è€…è¯æ˜å­˜åœ¨é‡è¯æŒæœ‰çš„ä¸€ä¸ªç‰¹å®šçš„` n `ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æƒ³ç»™å­˜åœ¨é‡è¯ä¸€ä¸ª*è§è¯*ã€‚ä¸€ä¸ªè¿™æ ·çš„è§è¯æ˜¯` 1 `ï¼Œå› ä¸º` k <= 1 == Fib(1) `ã€‚å¦ä¸€ä¸ªè¿™æ ·çš„è§è¯æ˜¯` 12 `ï¼Œå› ä¸º` k <= 144 == Fib(12) `ã€‚å¦ä¸€ä¸ªè¿™æ ·çš„è§è¯æ˜¯` k `ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬çš„ç®€å•ä¾‹å­ä¸­` k <= k == Fib(k) `ã€‚è®©æˆ‘ä»¬ç»§ç»­è¿™ä¸ªï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å¼•ç†ä¸»ä½“çš„â€œifâ€è¯­å¥çš„â€œthenâ€åˆ†æ”¯ä¸­æ·»åŠ ä¸€ä¸ªæ–­è¨€:

```dafny
assert k <= Fib(k);
```

Dafnyå°†è¯æ˜è¿™ä¸ªæ–­è¨€[3](http://leino.science/papers/krml267.html#fn-fn-dual-rail-encoding)ï¼Œç„¶åä¼šæ³¨æ„åˆ°` k `æ˜¯ä¸€ä¸ªè¯æ˜åç½®æ¡ä»¶çš„å­˜åœ¨è§è¯ã€‚åœ¨é€»è¾‘ä¸­ï¼Œè¿™è¢«ç§°ä¸ºâ€œå­˜åœ¨è®ºå¯¼è¨€â€ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªæ»¡è¶³ç‰¹å®šå±æ€§çš„å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼å°±å­˜åœ¨ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªâ€œåœ¨ä½ æ‰‹ä¸­â€çš„ä»·å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªä»·å€¼å°±å­˜åœ¨äº†â€”â€”è¿™ä¼¼ä¹æ˜¯å¦‚æ­¤æ˜æ˜¾ï¼Œä»¥è‡³äºæˆ‘ä»¬è°ˆèµ·å®ƒæ—¶å‡ ä¹ä¼šæ„Ÿåˆ°å°´å°¬(ä½ çš„é‚»å±…å¬åˆ°ä½ ä»¥è¿™ä¸ªä¸ºç”Ÿè‚¯å®šä¼šè®¤ä¸ºä½ ç–¯äº†)ã€‚

é‚£ä¹ˆè¿™ä¸ªæ£˜æ‰‹çš„æ¡ˆä¾‹å‘¢?æˆ‘ä»¬å¯ä»¥é€šè¿‡å½’çº³æ³•æ¥è¯æ˜ï¼Œé¦–å…ˆå¾—åˆ°ä¸€ä¸ªnï¼Œå®ƒçš„æ–æ³¢é‚£å¥‘å€¼è‡³å°‘ä¸ºk-1ï¼Œç„¶åå†ä»ä¸­æ„å»ºä¸€ä¸ªæ›´å¤§çš„æ–æ³¢é‚£å¥‘å€¼ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨â€œk-1â€ä¸Šé€’å½’åœ°è°ƒç”¨å¼•ç†:

```dafny
EverBigger(k-1);
```

è¿™è®©æˆ‘ä»¬è·å¾—äº†`EverBigger(k-1)`çš„åç½®æ¡ä»¶ã€‚ä¸ºäº†åœ¨æˆ‘ä»¬çš„è¯æ˜ä¸­æ˜ç¡®åœ°å†™ä¸‹è¿™ä¸€ç‚¹â€”â€”ä¸ºäº†æ£€æŸ¥éªŒè¯è€…æ˜¯å¦å¾—å‡ºäº†æˆ‘ä»¬æœŸæœ›ä»å¼•ç†è°ƒç”¨ä¸­å¾—åˆ°çš„ç»“è®ºï¼Œå¹¶æé†’æˆ‘ä»¬è‡ªå·±ä»€ä¹ˆå±æ€§â€”â€”æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªæ–­è¨€:

```dafny
assert exists n` :: k-1 <= Fib(n`);
```

å¥½åˆ°ç›®å‰ä¸ºæ­¢ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æƒ³æ„é€ ä¸€ä¸ªè‡³å°‘æ¯”Fib(n)å¤§` 1 `çš„æ–æ³¢é‚£å¥‘æ•°ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥å®Œæˆè¯æ˜ã€‚ä½†æ˜¯æˆ‘åˆšæ‰æåˆ°çš„næ˜¯ä»€ä¹ˆ?ä¸Šé¢çš„æ‰€æœ‰æ–­è¨€éƒ½å‘Šè¯‰æˆ‘ä»¬å­˜åœ¨è¿™æ ·çš„â€œnâ€ã€‚æˆ‘ä»¬å¸Œæœ›æœ‰è¿™æ ·ä¸€ä¸ªâ€œnâ€åœ¨æˆ‘ä»¬æ‰‹ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å®ƒã€‚

ä»æˆ‘ä»¬çŸ¥é“å­˜åœ¨çš„ä¸œè¥¿åˆ°â€œåœ¨æˆ‘ä»¬æ‰‹ä¸­â€çš„ä¸œè¥¿è¢«ç§°ä¸ºâ€œSkolemizationâ€æˆ–â€œexisteneliminationâ€ã€‚ä½ åœ¨Dafnyä¸­é€šè¿‡*assign-such-that*è¯­å¥å®ç°:

```dafny
var m: nat :| k-1 <= Fib(m);
```

è¿™ä¸ªè¯­å¥å¼•å…¥äº†ä¸€ä¸ªå±€éƒ¨å˜é‡` m `ï¼Œå¹¶ç»™å®ƒä¸€ä¸ªä»»æ„å€¼ï¼Œæ»¡è¶³` k-1 <= Fib(m) `ã€‚å½“ç„¶ï¼Œå¦‚æœä¸å­˜åœ¨è¿™æ ·çš„å€¼ï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥èµ‹å€¼-such-thatè¯­å¥å¼•èµ·äº†ä¸€ä¸ªè¯æ˜ä¹‰åŠ¡ï¼Œè¯æ˜è¿™æ ·çš„` m `å­˜åœ¨ã€‚è¿™ä¸ªè¯æ˜ä¹‰åŠ¡æ¥è‡ªäºæˆ‘ä»¬ä¸Šé¢æ–­è¨€çš„å±æ€§ã€‚

å·®ä¸å¤šäº†ã€‚ä¸ºäº†å»ºç«‹å¼•ç†çš„åç½®æ¡ä»¶ï¼Œæˆ‘ä»¬å‰©ä¸‹çš„è®¡åˆ’å°±æ˜¯æ„é€ ä¸€ä¸ªä¸¥æ ¼å¤§äº` Fib(m) `çš„æ–æ³¢é‚£å¥‘æ•°ã€‚æˆ‘ä»¬è§‚å¯Ÿåˆ°` Fib(m) + Fib(m+1) `ä¸¥æ ¼å¤§äº` Fib(m) `ï¼Œå› æ­¤æˆ‘ä»¬æœ‰` Fib(m+2) `ä¸¥æ ¼å¤§äº` Fib(m) `ã€‚

å¥½å§ï¼Œæˆ‘ä»¬ç›´è¯´äº†å§ã€‚ä¹Ÿè®¸æˆ‘ä»¬å¹¶æ²¡æœ‰â€œè§‚å¯Ÿâ€åˆ°è¿™ä¸€ç‚¹ï¼Œè€Œæ˜¯â€œå¸Œæœ›â€ã€â€œçŒœæƒ³â€æˆ–â€œæ¾æ•£åœ°è®¤ä¸ºâ€å®ƒå¯èƒ½æˆç«‹ã€‚å¥½å§ï¼Œç¡®å®å¦‚æ­¤ã€‚(å”·!)æˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¢é—®éªŒè¯è€…å®ƒæ˜¯å¦èƒ½ä¸ºæˆ‘ä»¬è¯æ˜æ¥éªŒè¯:

```dafny
assert k <= Fib(m) + Fib(m + 1) == Fib(m + 2);
```

éªŒè¯è€…ç«‹å³è¯æ˜äº†è¿™ä¸ªæ–­è¨€ã€‚[4](http://leino.science/papers/krml267.html#fn-fn-proof)æ­¤å¤–ï¼Œé€šè¿‡å†™ä¸‹è¿™ä¸ªæ–­è¨€ï¼Œæˆ‘ä»¬ä¹Ÿå‘éªŒè¯è€…å±•ç¤ºäº†è§è¯` m+2 `ï¼Œå®ƒè¯æ˜äº†å¼•ç†çš„åç½®æ¡ä»¶ä¸­çš„å­˜åœ¨é‡è¯ã€‚

æˆ‘ç”¨è¿™ä¸ªä¾‹å­æ¥è¯´æ˜çš„é‡ç‚¹æ˜¯ï¼Œä½ å¯ä»¥ç”¨Skolemizeä¸€ä¸ªé‡è¯

```dafny
exists x :: P
```

é€šè¿‡assign-such-thatè¯­å¥

```dafny
var x :| P;
```

æ³¨æ„æ ‡ç‚¹ç¬¦å·çš„åŒºåˆ«ã€‚

### å¸¦å¤–å‚æ•°çš„å¼•ç†

æˆ‘åˆšåˆšç»™ä½ ä»¬çœ‹äº†ä¸€ä¸ªæ¶‰åŠå­˜åœ¨é‡è¯çš„ä¾‹å­ã€‚è¿™ä¸ªä¾‹å­è¡¨æ˜ï¼Œâ€œEverBiggerâ€å¼•ç†çš„â€œè¯æ˜â€ä¸¤æ¬¡ä½¿ç”¨äº†å­˜åœ¨æ€§ä»‹ç»(åœ¨ç®€å•æƒ…å†µä¸‹ä¸º`Fib(k)`ï¼Œåœ¨å›°éš¾æƒ…å†µä¸‹ä¸º`Fib(m+2)`)ï¼Œä»è€Œå°†â€œæˆ‘ä»¬æ‰‹ä¸­â€çš„`k`å’Œ`m+2`è½¬æ¢ä¸ºå­˜åœ¨æ€§é‡åŒ–ã€‚è¿™ä¸ªä¾‹å­è¿˜å±•ç¤ºäº†(é€’å½’è°ƒç”¨)å¼•ç†çš„*è°ƒç”¨*ä½¿ç”¨å­˜åœ¨æ¶ˆé™¤æ¥å°†å¼•ç†çš„åç½®æ¡ä»¶ä¸­çš„å­˜åœ¨é‡åŒ–è½¬æ¢ä¸ºâ€œæˆ‘ä»¬æ‰‹ä¸­çš„â€ä¸€ä¸ª`m`ã€‚è®©äººå°è±¡æ·±åˆ»çš„æ˜¯ï¼ŒDafnyæœ‰è¿™æ ·çš„ç‰¹æ€§ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªæ›´æœ‰ç”¨çš„ç‰¹æ€§ï¼Œå¯ä»¥è®©ä½ åœ¨ä¸€å¼€å§‹å°±é¿å…è¿™äº›å­˜åœ¨-é‡è¯è½¬æ¢:å¼•ç†-å‚æ•°ã€‚

åœ¨æ•°å­¦ä¸­ï¼Œå¼•ç†æ˜¯ç”±å®ƒä»¬æ‰€æåˆ°çš„å˜é‡å‚æ•°åŒ–çš„ã€‚è¿™äº›éƒ½æ˜¯å‚æ•°ã€‚ä¸€ä¸ªæ•°å­¦å¼•ç†å¾ˆå°‘æˆ–æ°¸è¿œä¸ä¼šè¢«è®¤ä¸ºå…·æœ‰å¤–å‚æ•°ã€‚åœ¨Dafnyä¸­ï¼Œå¼•ç†å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå¹½çµæ–¹æ³•ï¼Œä¸€ä¸ªæ–¹æ³•å¯ä»¥åŒæ—¶å…·æœ‰è¾“å…¥å‚æ•°å’Œè¾“å‡ºå‚æ•°ã€‚è¿™æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ä¸å…¶ç”¨å¼•ç†æ¥è¯æ˜æŸä¸ªå€¼çš„â€œå­˜åœ¨â€ï¼Œè¿˜ä¸å¦‚ç›´æ¥â€œè¿”å›â€æŸä¸ªè¿™æ ·çš„å€¼ã€‚

ä¸‹é¢æ˜¯ä¸Šé¢çš„â€œEverBiggerâ€å¼•ç†ï¼Œä½†å°†`n`å£°æ˜ä¸ºoutå½¢å‚:

```dafny
lemma EverBigger(k: nat) returns (n: nat)
  ensures k <= Fib(n)
{
  if k < 2 {
    n := k;
  } else {
    var m := EverBigger(k-1);
    n := m + 2;
  }
}
```

### ç»‘å®šè­¦å«

Dafnyè¿˜åŒ…å«äº†å¦ä¸€ä¸ªç‰¹æ€§ï¼Œä½¿é‡è¯çš„ä½¿ç”¨æ›´åŠ æµç•…:å¸¦æœ‰*binding guard *çš„` if `è¯­å¥ã€‚è¿™æ ·çš„è¯­å¥å›ç­”äº†â€œå¦‚æœæœ‰ä¸€ä¸ªï¼Œç»™æˆ‘ä¸€ä¸ªåœ¨æˆ‘æ‰‹é‡Œâ€çš„å‘½ä»¤ã€‚

å‡è®¾æˆ‘ä»¬å†™ä¸€ä¸ªè¯æ˜ï¼Œæ ¹æ®yæ˜¯å¦ä¸ºæ–æ³¢é‚£å¥‘æ•°åˆ†æˆä¸¤ç§æƒ…å†µã€‚ç„¶åæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™:

```dafny
if exists n :: y == Fib(n) {
  var n :| y == Fib(n);
  // y is the nth Fibonacci number
} else {
  // y is not a Fibonacci number
}
```

è¿™è¡¨è¾¾äº†æˆ‘ä»¬æƒ³è¦çš„ï¼Œä½†æ„Ÿè§‰æœ‰ç‚¹ç¬¨æ‹™ï¼Œå› ä¸ºæˆ‘ä»¬é‡å¤äº†æ¡ä»¶` y == Fib(n) `ã€‚æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªâ€œifâ€è¯­å¥å†™æˆ

```dafny
if n :| y == Fib(n) {
  // y is the nth Fibonacci number
} else {
  // y is not a Fibonacci number
}
```

`:| `ä¸èµ‹å€¼such-thatè¯­å¥ä¸­çš„æ ‡ç‚¹ç›¸åŒï¼Œè€Œä¸æ˜¯å­˜åœ¨é‡è¯ä¸­ç±»ä¼¼ä½ç½®çš„`::`ã€‚

## é›†åˆå’Œæ˜ å°„

é€»è¾‘é‡è¯å’Œå…¶ä»–ç»“æ„å¼•å…¥äº†ä¸€äº›ç»‘å®šå˜é‡ï¼Œå¹¶ä»¥æŸç§æ–¹å¼é™åˆ¶äº†è¿™äº›ç»‘å®šå˜é‡çš„å–å€¼èŒƒå›´ã€‚é›†åˆç†è§£å’Œæ˜ å°„ç†è§£ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

### é›†åˆç†è§£

å¾ˆå®¹æ˜“åœ¨Dafnyå†™ä¸‹ä¸€ç»„ã€‚ä¾‹å¦‚,

```dafny
{ 2, 3, 5 }
```

æ˜¯ä¸‰ä¸ªæœ€å°ç´ æ•°çš„é›†åˆã€‚è¿™æ ·çš„è¡¨è¾¾å¼ï¼Œå…¶ä¸­é›†åˆçš„å…ƒç´ è¢«æ˜¾å¼åˆ—å‡ºï¼Œç§°ä¸º*set display*ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æƒ³è¦å®šä¹‰çš„é›†åˆä¸èƒ½å†™æˆé›†åˆæ˜¾ç¤ºï¼Œè¯¥æ€ä¹ˆåŠ?

é›†åˆç†è§£ä»¥å›¾è§£çš„æ–¹å¼å®šä¹‰äº†ä¸€ç»„å…ƒç´ ã€‚åœ¨æ™®é€šæ•°å­¦ç¬¦å·ä¸­é›†åˆç†è§£çš„ä¸€ä¸ªä¾‹å­æ˜¯



å®šä¹‰äº†æœ€å°çš„100ä¸ªè‡ªç„¶æ•°çš„é›†åˆã€‚å¦ä¸€ä¸ªä¾‹å­æ˜¯



å®ƒå®šä¹‰äº†100ä¸ªæœ€å°çš„å®Œå…¨å¹³æ–¹æ•°ã€‚è¿™ä¸¤ä¸ªæ¨å¯¼å¼ä¸­çš„ç»‘å®šå˜é‡éƒ½æ˜¯ï¼ŒæŒ‡å®šrangeçš„å€¼ç”±è°“è¯å®šä¹‰ã€‚è®©èŒƒå›´è¶…è¿‡è¿™äº›å€¼ï¼Œç¬¬ä¸€ä¸ªé›†åˆç„¶ååŒ…å«è¡¨å•çš„å…ƒç´ ï¼Œè€Œç¬¬äºŒä¸ªé›†åˆåŒ…å«è¡¨å•çš„å…ƒç´ ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç¬¬ä¸€ä¸ªé›†åˆä¸­ï¼Œå…ƒç´ æ˜¯è‡ªèº«çš„åˆæ³•å€¼ï¼Œè€Œåœ¨ç¬¬äºŒä¸ªé›†åˆä¸­ï¼Œå…ƒç´ æ˜¯æ¯ä¸ªåˆæ³•å€¼çš„å¹³æ–¹ã€‚

æ›´ä¸€èˆ¬åœ°è¯´ï¼Œæ•°å­¦ç¬¦å·çš„å½¢çŠ¶æ˜¯è¿™æ ·çš„ã€‚è¯»è€…åº”è¯¥ç†è§£è¿™æ˜¯ç»‘å®šå˜é‡ã€‚ç†è§£ä¸ºç»‘å®šå˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç²¾ç¡®æè¿°é›†åˆä½•æ—¶åŒ…å«ä¸€ä¸ªå…ƒç´ æ¥å®šä¹‰é›†åˆæ¨å¯¼å¼:



æˆ–è€…ï¼Œä½¿ç”¨å­˜åœ¨å‡½æ•°çš„å–å€¼èŒƒå›´å•ç‹¬ç»™å‡ºçš„ç¬¦å·:



åœ¨Dafnyä¸­ï¼ŒåŒæ ·çš„é›†åˆç†è§£æœ‰å¦‚ä¸‹å½¢å¼:

```dafny
set x | R :: f(x)
```

` x `æ˜¯ç»‘å®šå˜é‡(æˆ–è€…ï¼Œæ›´æ™®éåœ°è¯´ï¼Œä¸€ä¸ªç»‘å®šå˜é‡çš„åˆ—è¡¨)ï¼Œ` R `æ˜¯ç»‘å®šå˜é‡çš„èŒƒå›´è°“è¯ï¼Œè€Œ` f(x) `æ˜¯é›†åˆæ¨å¯¼çš„*é¡¹è¡¨è¾¾å¼*ã€‚ç»‘å®šå˜é‡è¢«æ˜¾å¼åˆ—å‡ºï¼Œä¸åƒæ™®é€šçš„æ•°å­¦ç¬¦å·ï¼Œè¯»è€…å¿…é¡»æ¨æ–­ç»‘å®šå˜é‡æ˜¯ä»€ä¹ˆã€‚ä¸Šé¢ç»™å‡ºçš„ä¸¤ä¸ªç¤ºä¾‹é›†åœ¨Dafnyä¸­å†™å¦‚ä¸‹:

```dafny
set x | 0 <= x < 100 :: x
set x | 0 <= x < 100 :: x*x
```

è™½ç„¶ä¹ä¸€çœ‹ä¸å¤ªç®€æ´ï¼Œä½†æ˜¾å¼åˆ—å‡ºç»‘å®šå˜é‡çš„è¡¨ç¤ºæ³•æœ‰ä¸€äº›ç»†å¾®ä¹‹å¤„ã€‚

ä¸€ä¸ªç»†å¾®ä¹‹å¤„æ˜¯ï¼Œå°±åƒä¸Šé¢ä¸€æ ·ï¼Œé‡è¯çš„å®šä¹‰æ˜¾ç¤ºäº†ç¬¦å·çš„ç›¸ä¼¼æ€§:

```dafny
y in (set x | R :: f(x))   <==>   exists x | R :: y == f(x)
```

å¦ä¸€ä¸ªä¼˜ç‚¹æ˜¯å¯ä»¥å¾ˆå®¹æ˜“åœ°åˆ—å‡ºé™„åŠ çš„ç»‘å®šå˜é‡ã€‚å‡è®¾` R `æ˜¯` x `å’Œ` z `çš„è°“è¯ï¼Œé‚£ä¹ˆè¿™é‡Œæœ‰ä¸¤ä¸ªä¾‹å­:

```dafny
set x,n | Fib(n) <= x < Fib(n) + n :: f(x)
set x,n | Fib(n) <= x < Fib(n) + n :: g(x,n)
```

ç¬¬ä¸€ä¸ªé›†åˆåŒ…å«f(x)å¯¹äºæ¯ä¸ªåœ¨` n `èŒƒå›´å†…çš„` x `å¯¹äºæŸäº›` n `çš„` Fib(n) `ã€‚ç”¨æ™®é€šçš„æ•°å­¦ç¬¦å·æ¥è¡¨ç¤ºå®ƒçš„ä¸€ç§ç­‰ä»·çš„æ–¹å¼æ˜¯:



ç¬¬äºŒä¸ªé›†åˆåŒ…å«` g(x,n) `å¯¹äºæ¯ä¸ª` x `å’Œ` n `ï¼Œä½¿` x `åœ¨` Fib(n) `çš„` n `ä¹‹å†…ã€‚åœ¨è¿™é‡Œï¼Œç­‰æ•ˆçš„æ•°å­¦ç¬¦å·æ›´ç¬¨æ‹™ï¼Œéœ€è¦ä½¿ç”¨å¦ä¸€ä¸ªç»‘å®šå˜é‡:



Dafnyä½¿ç»‘å®šå˜é‡æ˜¾å¼çš„ä¸€èˆ¬è¡¨ç¤ºæ³•ä¹Ÿè¢«è®¸å¤šä½œè€…ä½¿ç”¨(ä¾‹å¦‚ï¼Œ[[3](http://leino.science/papers/krml267.html#dijkstra:discipline)ï¼Œ [4](http://leino.science/papers/krml267.html#griesschneider:proofs)])ã€‚å®ƒä¹Ÿç±»ä¼¼äºå…¶ä»–è¯­è¨€ä¸­ä½¿ç”¨çš„åˆ—è¡¨ç†è§£è¡¨ç¤ºæ³•ã€‚ä¾‹å¦‚ï¼ŒDafnyç³»åˆ—

```dafny
set x,y | 0 <= x <= y <= 100 && x + y == 100 :: (x,y)
```

å®ƒåŒ…å«ä¸€å¯¹è‡ªç„¶æ•°ä¹‹å’Œä¸º` 100 `ï¼ŒåŒ…å«ä¸Pythonåˆ—è¡¨ç›¸åŒçš„å…ƒç´ :

```dafny
[(x,y) for x in range(0, 101) for y in range(x, 101) if x + y == 100]
```

Haskellåå•:

```dafny
[(x,y) | x <- [0..100], y <- [x..100], x + y = 100]
```

### ç®€åŒ–çš„é›†åˆç†è§£

æˆ‘åˆšåˆšèŠ±äº†å¾ˆå¤šæ–‡å­—æ¥æè¿°Dafnyä¸­çš„ä¸€èˆ¬é›†åˆç†è§£ç¬¦å·ã€‚ç„¶è€Œï¼Œåœ¨å®è·µä¸­çš„è®¸å¤šé›†åˆæ¨å¯¼ä¸­ï¼Œåªæœ‰ä¸€ä¸ªçº¦æŸå˜é‡ï¼Œè€Œæœ¯è¯­è¡¨è¾¾å¼å°±æ˜¯é‚£ä¸ªçº¦æŸå˜é‡ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼Œæœ€å°çš„â€œ100â€è‡ªç„¶æ•°çš„é›†åˆæ˜¯:

```dafny
set x | 0 <= x < 100 :: x
```

å¯¹äºè¿™ç§å¸¸è§çš„æƒ…å†µï¼ŒDafnyå…è®¸ä½ çœç•¥æœ¯è¯­è¡¨è¾¾å¼ï¼Œåªéœ€è¦å†™:

```dafny
set x | 0 <= x < 100
```

è¿™ä¸ªè¡¨è¾¾å¼çœ‹èµ·æ¥åƒæ™®é€šçš„æ•°å­¦ç¬¦å·ã€‚äº‹å®ä¸Šï¼Œå¯¹äºè¿™äº›ç®€åŒ–çš„é›†åˆæ¨å¯¼å¼ï¼Œå¾ˆå®¹æ˜“â€œç†è§£â€æ•°å­¦ç¬¦å·æƒ³è¦è¡¨è¾¾çš„çº¦æŸå˜é‡æ˜¯ä»€ä¹ˆã€‚

ä½œä¸ºDafnyä¸­éªŒè¯å™¨çš„ä¸€ä¸ªæ³¨é‡Šï¼Œè‡ªåŠ¨åŒ–å€¾å‘äºæ›´å¥½åœ°å·¥ä½œäºç®€åŒ–çš„é›†åˆæ¨å¯¼å¼ï¼Œå…¶ä¸­æœ¯è¯­è¡¨è¾¾å¼å¯ä»¥è¢«çœç•¥ã€‚

### æ˜ å°„ç†è§£

ä¸€ä¸ª*map*æœ¬è´¨ä¸Šæ˜¯ä¸€ç»„å¯¹ï¼Œå…¶ä¸­å¯¹çš„å·¦å…ƒç´ æ˜¯å”¯ä¸€çš„(ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªå·¦å…ƒç´ åœ¨åŠŸèƒ½ä¸Šå†³å®šäº†ç›¸åº”çš„å³å…ƒç´ )ã€‚ä¸é›†åˆçš„æ˜¾ç¤ºè¡¨è¾¾å¼ä¸€æ ·ï¼Œmapå¯ä»¥é€šè¿‡*map display*æ¥å®šä¹‰ã€‚ä¾‹å¦‚,

```dafny
map[2 := `c`, 137 := `a`]
```

å°†æ•´æ•°` 2 `æ˜ å°„åˆ°å­—ç¬¦` c `ï¼Œå°†æ•´æ•°` 137 `æ˜ å°„åˆ°å­—ç¬¦` a `ã€‚æ¯ä¸€å¯¹åƒ` 2:= c `å¯ä»¥è¢«ç§°ä¸ºä¸€ä¸ª*maplet*ã€‚æ­¤å¤–ï¼Œmapletçš„å·¦å…ƒç´ ç§°ä¸ºa *key*ï¼Œå³å…ƒç´ è·å¾—ä¸å¯æè¿°çš„åç§°*value*ã€‚

ä¸é›†åˆçš„ç†è§£ä¸€æ ·ï¼Œæ˜ å°„å¯ä»¥é€šè¿‡*mapç†è§£*æ¥å®šä¹‰ã€‚å®ƒçš„å½¢å¼æ˜¯:

```dafny
map x | R :: f(x) := g(x)
```

ä¾‹å¦‚ï¼Œ

```dafny
map x | 0 <= x < 100 :: x*x := x
```

æ˜¯ä»å‰100ä¸ªå®Œå…¨å¹³æ–¹æ•°åˆ°å®ƒä»¬å„è‡ªçš„å¹³æ–¹æ ¹çš„æ˜ å°„ã€‚

å¦‚æœæ‚¨å°†æ˜ å°„ç†è§£ç†è§£ä¸ºä¸€ç»„å…·æœ‰å”¯ä¸€é”®çš„mapletsï¼Œé‚£ä¹ˆæ‚¨åŸºæœ¬ä¸Šå·²ç»ç†è§£äº†ç¬¦å·ã€‚ä¸è¿‡ï¼Œæˆ‘å°†æä¾›ä¸€äº›æ³¨é‡Šå¹¶æŒ‡å‡ºæ˜ å°„ç‰¹æœ‰çš„ä¸€äº›ç‰¹æ€§ã€‚

éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œmapletså¿…é¡»å…·æœ‰å”¯ä¸€çš„é”®ã€‚ä¾‹å¦‚ï¼ŒéªŒè¯è€…ä¼šæŠ±æ€¨ï¼Œå¦‚æœä½ è¯•ç€å†™ä¸€ä¸ªåƒè¿™æ ·çš„æ˜ å°„ç†è§£

```dafny
map x | -10 <= x <= 10 :: x*x := x
```

å› ä¸ºå®ƒè¯´æŠŠ4æ˜ å°„åˆ°2å’Œ-2ä¸Šï¼Œè¿™æ˜¯æ²¡ç”¨çš„ã€‚

ä¸€èˆ¬çš„æ˜ å°„ç†è§£è¡¨è¾¾æ˜¯ç›¸å½“çµæ´»çš„ã€‚ä¾‹å¦‚ï¼Œå‡è®¾` m `æ˜¯ä¸€ä¸ªä»æ•°å­—åˆ°å­—ç¬¦çš„æ˜ å°„ï¼Œå¹¶å‡è®¾æˆ‘ä»¬æƒ³è¦åˆ›å»ºä¸€ä¸ªæ–°çš„æ˜ å°„` n `ï¼Œä»` m `ä¸­çš„é”®çš„å­é›†åˆ°å…¶ä»–ä¸€äº›å­—ç¬¦ã€‚æ›´å‡†ç¡®åœ°è¯´ï¼Œå½“` m `ä¸­çš„é”®åœ¨å‡½æ•°` f `çš„å›¾åƒä¸­ï¼Œæ¯”å¦‚ä¸€ä¸ªé”®` f(x) `å¯¹äºæŸä¸ª` x `ï¼Œç„¶åæˆ‘ä»¬æƒ³è®©` n `å°†è¿™ä¸ªé”®æ˜ å°„åˆ°` h(x) `ã€‚ç„¶åæˆ‘ä»¬å°†nå®šä¹‰ä¸º

```dafny
map x | f(x) in m.Keys :: f(x) := h(x)
```

ç„¶è€Œï¼Œå¤§å¤šæ•°æ—¶å€™ï¼Œæˆ‘ä»¬å€¾å‘äºå†™çš„æ˜ å°„ç†è§£å…·æœ‰è¿™ç§å½¢å¼

```dafny
map x | R :: x := g(x)
```

å¯¹äºè¿™äº›å¸¸è§çš„æ˜ å°„ï¼ŒDafnyå…è®¸æˆ‘ä»¬çœç•¥â€œ` x:= `â€ï¼Œåªå†™

```dafny
map x | R :: g(x)
```

åœ¨å®è·µä¸­ï¼Œå‡ ä¹æ‰€æœ‰çš„æ˜ å°„ç†è§£éƒ½å¯ä»¥ç”¨è¿™ç§ç®€åŒ–çš„å½¢å¼æ¥å†™ã€‚ä½†æ˜¯å½“ç®€åŒ–å½¢å¼ä¸å……åˆ†æ—¶(å°±åƒä¸Šé¢çš„maplets ` f(x):= h(x) `çš„ä¾‹å­ä¸€æ ·)ï¼Œä¸€èˆ¬å½¢å¼æ˜¯å¯ç”¨çš„ã€‚

### Lambda expressions

æœ€åï¼Œè¦æ³¨æ„æ˜ å°„å’Œå‡½æ•°ä¹‹é—´çš„åŒºåˆ«ã€‚æ‚¨å¯ä»¥å°†mapçœ‹ä½œæ˜¯ä¸€ä¸ªé¢„å…ˆè®¡ç®—å¥½çš„è¡¨ï¼Œè€Œå‡½æ•°åˆ™æ˜¯ä»ä¸€ä¸ªç»™å®šçš„é”®ä¸­è®¡ç®—å‡ºä¸€ä¸ªå€¼ã€‚ä¸ºäº†è¿›è¡Œæ¯”è¾ƒï¼Œè®©æˆ‘ä»¬è€ƒè™‘ç¼–å†™æ˜ å°„

```dafny
map x | R :: g(x)
```

ä½œä¸ºä¸€ä¸ªå‡½æ•°ã€‚

é€šå¸¸ï¼Œå‡½æ•°æ˜¯ç”¨åç§°å£°æ˜çš„ã€‚ä¸Šé¢çš„æ˜ å°„æ˜¯æ²¿ç€çº¿å†™çš„

```dafny
function F(x: X): Y
  requires R
{
  g(x)
}
```

å‡½æ•°ä¹Ÿå¯ä»¥æ˜¯åŒ¿åçš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒé€šå¸¸è¢«ç§°ä¸º*lambdaè¡¨è¾¾å¼*ã€‚ç„¶åç¼–å†™ç¤ºä¾‹æ˜ å°„

```dafny
x requires R => g(x)
```

## æ€»ç»“

ä»¥ä¸‹æ˜¯æœ¬æ–‡ä¸­è®¨è®ºçš„è¯­æ³•å½¢å¼:

```dafny
forall x :: P
forall x | R :: P
forall x | R ensures P { S; }
exists x :: P
exists x | R :: P
var x :| P;
if x :| P { S; }
set x | R :: f(x)
set x | R
map x | R :: f(x) := h(x)
map x | R :: g(x)
function F(x: X): Y { g(x) }
x requires R => g(x)
```

## è‡´è°¢

æˆ‘å¾ˆæ„Ÿè°¢Jay Lorchåœ¨è¿™å¼ ä¾¿æ¡ä¸Šçš„è®¸å¤šæœ‰å¸®åŠ©çš„è¯„è®ºã€‚

## å‚è€ƒæ–‡çŒ®

[0]Nada Amin, K. Rustan M. Leino, and Tiark Rompf. Computing with an SMT solver. In Martina Seidl and Nikolai Tillmann, editors, *Tests and Proofs â€” 8th International Conference, TAP 2014*, volume 8570 of *Lecture Notes in Computer Science*, pages 20â€“35. Springer, July 2014. [ğŸ”](http://www.bing.com/search?q=Computing+with+solver++Nada+Amin+Rustan+Leino+Tiark+Rompf+)

[1]FranÃ§ois Bobot, Jean-Christophe FilliÃ¢tre, Claude MarchÃ©, and Andrei Paskevich. Why3: Shepherd your herd of provers. In *Boogie 2011: First International Workshop on Intermediate Verification Languages*, pages 53â€“64, WrocÅ‚aw, Poland, August 2011. [https://hal.inria.fr/hal-00790310](https://hal.inria.fr/hal-00790310). [ğŸ”](http://www.bing.com/search?q=Fran+Bobot+Jean+Christophe+Filli+Claude+March+Andrei+Paskevich+Why3+Shepherd+your+herd+provers+_Boogie+First+International+Workshop+Intermediate+Verification+Languages_+pages+Wroc+Poland+August+https+inria++)

[2]K. Mani Chandy and Jayadev Misra. *Parallel Program Design: A Foundation*. Addison-Wesley, 1988. [ğŸ”](http://www.bing.com/search?q=_Parallel+Program+Design+Foundation_+++Mani+Chandy+Jayadev+Misra+)

[3]Edsger W. Dijkstra. *A Discipline of Programming*. Prentice Hall, Englewood Cliffs, NJ, 1976. [ğŸ”](http://www.bing.com/search?q=+Discipline+Programming_++Edsger+Dijkstra+)

[4]David Gries and Fred B. Schneider. *A Logical Approach to Discrete Math*. Texts and Monographs in Computer Science. Springer-Verlag, 1994. [ğŸ”](http://www.bing.com/search?q=+Logical+Approach+Discrete+Math_++David+Gries+Fred+Schneider+)

[5]Gary T. Leavens, Albert L. Baker, and Clyde Ruby. JML: A notation for detailed design. In Haim Kilov, Bernhard Rumpe, and Ian Simmonds, editors, *Behavioral Specifications of Businesses and Systems*, pages 175â€“188. Kluwer Academic Publishers, 1999. [ğŸ”](http://www.bing.com/search?q=+notation+detailed+design++Gary+Leavens+Albert+Baker+Clyde+Ruby+)

[6]K. Rustan M. Leino and ClÃ©ment Pit-Claudel. Trigger selection strategies to stabilize program verifiers. In Swarat Chaudhuri and Azadeh Farzan, editors, *Computer Aided Verification - 28th International Conference, CAV 2016, Proceedings, Part I*, volume 9779 of *Lecture Notes in Computer Science*, pages 361â€“381. Springer, 2016. [ğŸ”](http://www.bing.com/search?q=Trigger+selection+strategies+stabilize+program+verifiers+++Rustan+Leino+ment+Claudel+)



------

0.ç”¨äºDafnyæ’ç‰ˆçš„Emacs IDEæŸäº›Dafnyç»“æ„çš„ç¬¦å·ä½ æ›´å¯èƒ½åœ¨è®ºæ–‡ä¸­çœ‹åˆ°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒæ˜¾ç¤º` forall x:: P ` aså’Œæ˜¾ç¤º` exists x:: P ` asã€‚[â†©](http://leino.science/papers/krml267.html # back-fn-fn-emacs)

1.åœ¨å†…éƒ¨ï¼ŒDafnyéªŒè¯å™¨å¯ä»¥æ›´æœ‰æ•ˆåœ°ä½¿ç”¨æŸäº›é‡è¯ã€‚éªŒè¯è€…è¯•å›¾æ£€æµ‹ä¸€ä¸ªç»™å®šé‡è¯çš„å¦ä¸€ç§å½¢å¼ä½•æ—¶å¯èƒ½æ‰§è¡Œå¾—æ›´å¥½ï¼Œå¹¶å°†åœ¨è¿™äº›æƒ…å†µä¸‹è‡ªåŠ¨é‡å†™é‡è¯[[6](http://leino.science/papers/krml267.html#leinopit-claudel:cav2016)]ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥é€‰æ‹©è§£é™¤æŸäº›é‡è¯çš„åµŒå¥—ã€‚è¿™ç§é‡å†™çš„ç›®æ ‡æ˜¯åœ¨è·å¾—è‰¯å¥½çš„éªŒè¯æ€§èƒ½çš„åŒæ—¶æ”¯æŒè‡ªç„¶å¤–è§‚çš„ç¨‹åºã€‚[â†©](http://leino.science/papers/krml267.html # back-fn-fn-nested)

2.äº‹å®è¯æ˜ï¼ŒDafnyçš„è‡ªåŠ¨å½’çº³å°†è‡ªåŠ¨è¯æ˜` FibProperty `å’Œ` FibPropertyAll `ã€‚å¦‚æœè¿™æ˜¯æˆ‘ä»¬å”¯ä¸€å…³å¿ƒçš„å¼•ç†ï¼Œé‚£å°±æ²¡æœ‰ä»€ä¹ˆå¥½è¯´æˆ–åšçš„äº†ã€‚å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘è¿˜æ˜¯ç”¨è¿™ä¸ªä¾‹å­æ¥å±•ç¤ºâ€œforallâ€è¯­å¥ã€‚å¦‚æœä½ æƒ³è¦ç¡®ä¿æˆ‘å°†è¦è¯´çš„æ˜¯ä¸€ä¸ªè¯æ˜ï¼Œä½ å¯ä»¥é€šè¿‡ä½¿ç”¨å±æ€§` {:induction false} `æ¥å…³é—­` FibPropertyAll `çš„è‡ªåŠ¨æ„Ÿåº”ã€‚[â†©](http://leino.science/papers/krml267.html # back-fn-fn-fibpropertyall)

3.Dafnyä¹Ÿå¯ä»¥è¯æ˜ç±»ä¼¼æ–­è¨€` assert Fib(12) == 144; `ã€‚åœ¨å†…éƒ¨ï¼ŒDafnyä½¿ç”¨äº†å‡½æ•°çš„â€œåŒè½¨ç¼–ç â€ï¼Œä½¿å…¶èƒ½å¤Ÿè·å¾—` Fib(12) `çš„å€¼(å› ä¸º` 12 `æ˜¯ä¸€ä¸ªæ–‡å­—å¸¸é‡)å’Œ` Fib(k) `(å…¶ä¸­` k `æ˜¯ä¸€ä¸ªå˜é‡)ã€‚å¦‚æœæ‚¨å¯¹è¿™æ˜¯å¦‚ä½•å®ç°çš„æ„Ÿå…´è¶£ï¼Œæˆ‘å»ºè®®æ‚¨è®¿é—®[[0](http://leino.science/papers/krml267.html#aminetal:computingwithsmt)]ã€‚[â†©](http://leino.science/papers/krml267.html # back-fn-fn-dual-rail-encoding)

4.è¿™é‡Œæ˜¯æ–­è¨€` k <= Fib(m) + Fib(m+1) `çš„ä¸€ä¸ªè¯æ˜ã€‚åœ¨æˆ‘ä»¬çš„è¯æ˜ä¸­ï¼Œâ€œå›°éš¾çš„æƒ…å†µâ€é€‚ç”¨äºå½“` k `è‡³å°‘ä¸º` 2 `æ—¶ï¼Œæ‰€ä»¥` k-1 `è‡³å°‘ä¸º` 1 `ï¼Œæ‰€ä»¥æˆ‘ä»¬çŸ¥é“` Fib(m) `è‡³å°‘ä¸º` 1 `ã€‚ç”±æ­¤å¯ä»¥å¾—å‡ºç»“è®ºï¼Œå¯¹äºFib(0) == 0ï¼Œ ` m `ä¸èƒ½ä¸º` 0 `ã€‚è¿™å¾ˆé‡è¦ï¼Œå› ä¸ºè¿™æ„å‘³ç€` m+1 `è‡³å°‘ç­‰äº` 2 `ï¼Œå› æ­¤é€‚ç”¨äº` Fib `å®šä¹‰çš„å½’çº³æƒ…å†µã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬æœ‰` Fib(m+1) == Fib(m) + Fib(m-1) `ã€‚æˆ‘ä»¬å·²ç»å¾—å‡ºï¼ŒFib(m)è‡³å°‘ç­‰äº1ã€‚ä»¥` Fib `è¿”å›` nat `ä¸ºä¾‹ï¼Œæˆ‘ä»¬çŸ¥é“` Fib(m-1) `è‡³å°‘ä¸º` 0 `ã€‚æ‰€ä»¥ï¼ŒFib(m+1)è‡³å°‘ç­‰äº1ã€‚æ¢å¥è¯è¯´ï¼Œ` Fib(m) + Fib(m+1) `è‡³å°‘æ¯”` Fib(m) `å¤§äº` 1 `ï¼Œè€Œ` Fib(m) `è‡³å°‘ç­‰äº` k-1 `ã€‚å› æ­¤ï¼Œ` Fib(m) + Fib(m+1) `è‡³å°‘ç­‰äº` k `ã€‚

å¦‚æœæˆ‘ä»¬æŠŠâ€œç®€å•çš„æƒ…å†µâ€å’Œâ€œå›°éš¾çš„æƒ…å†µâ€åˆ†å¼€ï¼Œä½¿â€œç®€å•çš„æƒ…å†µâ€åªåŒ…å«â€œk == 0â€ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸å¯èƒ½åœ¨ä¸Šé¢çš„è®ºè¯ä¸­å¾—å‡ºâ€œm != 0â€çš„ç»“è®ºã€‚å…¶ä»–äº¤äº’å¼è¯æ˜åŠ©æ‰‹çš„ä¸€äº›ç”¨æˆ·å¯èƒ½ä¼šå¯¹æ­¤æ„Ÿåˆ°å›°æ‰°ï¼Œå› ä¸ºä»–ä»¬ä¼šè¯´` k `å…·æœ‰` nat `ç±»å‹ï¼Œå› æ­¤å¯¹` k `çš„å½’çº³åº”è¯¥ä½¿ç”¨` k == 0 `ä½œä¸ºåŸºæœ¬æƒ…å†µã€‚æ•°å­¦å¯¹å½’çº³æ³•æ²¡æœ‰è¿™æ ·çš„é™åˆ¶ï¼Œäº‹å®ä¸Šï¼Œæ­£å¦‚è¿™ä¸ªè¯æ˜æ‰€æ˜¾ç¤ºçš„ï¼Œæˆ‘ä»¬å¯ä»¥ä»å°†â€œEverBiggerâ€çš„æƒ…å†µåˆ†æˆâ€œk < 2â€å’Œâ€œ2 <= kâ€ä¸­è·ç›Šã€‚[â†©](http://leino.science/papers/krml267.html # back-fn-fn-proof)